from flask import Flask, render_template, request, jsonify
import os
import shutil

app = Flask(__name__)

def list_files_in_directory(directory_path):
    """Recursively list all files and subfolders in a directory."""
    files = []
    for root, dirs, filenames in os.walk(directory_path):
        for filename in filenames:
            files.append(os.path.relpath(os.path.join(root, filename), directory_path))
    return files

def get_unique_filename(dest_folder, filename):
    base, extension = os.path.splitext(filename)
    counter = 1
    new_filename = filename
    while os.path.exists(os.path.join(dest_folder, new_filename)):
        new_filename = f"{base}({counter}){extension}"
        counter += 1
    return new_filename

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/get_folder_contents', methods=['POST'])
def get_folder_contents():
    folder_path = request.json.get('folderPath', '')
    if not os.path.isdir(folder_path):
        return jsonify({'status': 'error', 'message': 'Invalid folder path.'}), 400
    files_and_folders = list_files_in_directory(folder_path)
    return jsonify({'status': 'success', 'files': files_and_folders})

@app.route('/copy_files', methods=['POST'])
def copy_files():
    source_folder = request.form['sourceFolder']
    destination_folder = request.form['destinationFolder']
    selected_files = request.form.getlist('selectedFiles')

    if not os.path.isdir(source_folder):
        return jsonify({'status': 'error', 'message': 'Invalid source folder path.'})

    if not os.path.isdir(destination_folder):
        return jsonify({'status': 'error', 'message': 'Invalid destination folder path.'})

    try:
        for file in selected_files:
            source_path = os.path.join(source_folder, file)
            if os.path.exists(source_path):
                unique_filename = get_unique_filename(destination_folder, os.path.basename(file))
                destination_path = os.path.join(destination_folder, unique_filename)
                shutil.copy(source_path, destination_path)

        return jsonify({'status': 'success', 'message': 'Files copied successfully!'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)})

if __name__ == '__main__':
    app.run(debug=True)
